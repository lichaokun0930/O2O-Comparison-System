# 数据质量检测使用指南

## 📋 功能简介

**数据质量检测**是O2O比价工具阶段2优化的核心功能之一，在数据加载后自动检测7种常见数据问题，帮助用户提前发现并修复脏数据，避免"垃圾输入→垃圾输出"。

### 核心价值
- ✅ **提前发现问题**：在运行前检测，节省时间
- ✅ **避免无效运行**：严重问题可阻断运行
- ✅ **提升准确率**：干净数据带来更好的匹配效果
- ✅ **友好提示**：清晰的问题说明和修复建议

---

## 🚀 快速开始

### 启动程序（正常流程）

```powershell
# 1. 准备数据文件
#    - 将本店Excel放入: upload/本店/
#    - 将竞对Excel放入: upload/竞对/

# 2. 运行程序
python product_comparison_tool_local.py

# 3. 程序会在数据加载后自动进行质量检测
```

### 检测执行时机

```
⏳ [步骤 4/7] 正在处理「本店」的数据...
✅ 加载完成：120个商品

⏳ [步骤 4/7] 正在处理「竞对」的数据...
✅ 加载完成：150个商品

🔍 [步骤 4.2/7] 数据质量检测...  ⬅️ 自动执行
```

---

## 📊 检测项详解

### 1. 必需列缺失 🚨严重问题

**检测逻辑**：检查是否存在"商品名称"和"售价"两个必需列

**触发条件**：
- 缺少"商品名称"列
- 缺少"售价"列

**示例报告**：
```
❌ 缺少必需列: 售价
```

**解决方案**：
1. 打开Excel文件
2. 确保有"商品名称"和"售价"列
3. 列名必须完全一致（注意中文标点）
4. 重新保存并运行

**影响**：阻断运行（需用户确认是否继续）

---

### 2. 商品名空值率过高 ⚠️警告

**检测逻辑**：统计"商品名称"列的空值比例

**触发条件**：
- 空值率 > 10%

**示例报告**：
```
⚠️ 商品名称空值率 15.0% (18个)，建议<10%
```

**解决方案**：
1. 在Excel中筛选"商品名称"空值行
2. 补充商品名称或删除无效行
3. 重新保存并运行

**影响**：不阻断运行，但会降低匹配准确率

---

### 3. 商品名重复率高 ⚠️警告

**检测逻辑**：统计重复的商品名称比例

**触发条件**：
- 重复率 > 30%

**示例报告**：
```
⚠️ 商品名重复率 35.0% (42个)，可能包含多规格商品
```

**说明**：
- 这**不一定是问题**！
- 多规格商品（如不同尺寸的同款商品）会导致商品名重复
- 程序已内置多规格识别逻辑，无需特别处理

**何时需要关注**：
- 如果您的商品本应唯一（如不同SKU应有不同商品名）
- 如果重复率异常高（>50%）

**影响**：不阻断运行，仅提示注意

---

### 4. 编码问题（乱码） 🚨严重问题

**检测逻辑**：检查商品名称中是否包含"�"（乱码占位符）

**触发条件**：
- 发现任何包含"�"的商品名

**示例报告**：
```
❌ 发现 5 个乱码商品名（文件编码错误），建议用UTF-8重新保存Excel
```

**解决方案**：

**方法1：使用Excel另存为**
1. 打开原始Excel文件
2. 点击"文件" → "另存为"
3. 选择"CSV UTF-8 (逗号分隔)(*.csv)"
4. 保存并重命名为`.xlsx`
5. 重新运行程序

**方法2：使用记事本转换**
1. 将Excel导出为CSV
2. 用记事本打开
3. 点击"文件" → "另存为"
4. 编码选择"UTF-8"
5. 重新导入Excel并保存

**影响**：阻断运行（乱码会导致匹配失败或程序崩溃）

---

### 5. 价格异常 ⚠️警告

**检测逻辑**：检查价格是否 ≤0 或为空值

**触发条件**：
- 价格 ≤ 0
- 价格为空值
- 价格为负数（会额外标记为严重问题）

**示例报告**：
```
⚠️ 发现 10 个无效价格（空值:5个, ≤0:5个）
```

**负价格严重问题**：
```
❌ 发现 3 个负价格，数据异常
```

**解决方案**：
1. 筛选价格 ≤0 的行
2. 检查原因：
   - 促销活动？→ 设置为0.01
   - 数据录入错误？→ 修正价格
   - 缺货商品？→ 删除或补充价格
3. 重新保存并运行

**影响**：
- 无效价格（≤0或空值）：不阻断，但影响匹配
- 负价格：阻断运行（数据异常）

---

### 6. 价格离群值 ⚠️警告

**检测逻辑**：检查价格是否超过¥10,000元

**触发条件**：
- 价格 > ¥10,000

**示例报告**：
```
⚠️ 发现 2 个高价商品（>¥10000，最高¥25000.00），请确认是否正确
```

**说明**：
- 这**不一定是问题**！
- 高价商品（如家电、家具）是正常的
- 仅提示您确认数据是否录入正确

**何时需要关注**：
- 如果您销售的都是低价商品（如零食、日用品）
- 如果价格明显异常（如¥250000.00可能是多输了两个0）

**影响**：不阻断运行，仅提示确认

---

### 7. 数据规模过小 ⚠️警告

**检测逻辑**：统计商品总数

**触发条件**：
- 商品数量 < 100个

**示例报告**：
```
⚠️ 商品数量较少（50个），匹配结果可能不理想（建议≥100个）
```

**说明**：
- 商品数量过少会影响匹配效果
- 向量匹配需要足够的候选池
- 建议至少100个商品以上

**解决方案**：
1. 补充更多商品数据
2. 或接受较低的匹配准确率
3. 考虑调整匹配参数（降低阈值）

**影响**：不阻断运行，但会影响匹配质量

---

### 8. 条码格式异常 ⚠️警告

**检测逻辑**：检查条码长度是否在8-13位之间

**触发条件**：
- 条码长度 < 8位
- 条码长度 > 13位

**示例报告**：
```
⚠️ 发现 5 个异常长度条码（标准长度8-13位）
```

**说明**：
- 标准条码（EAN-8/EAN-13/UPC）长度为8、12或13位
- 异常长度可能导致条码精确匹配失败

**解决方案**：
1. 检查条码是否录入正确
2. 去除条码前后的空格
3. 如果是内部编码（非标准条码），忽略此警告

**影响**：不阻断运行，但影响条码精确匹配

---

## 🎯 实际使用场景

### 场景1：数据质量优秀（自动通过）

**输出示例**：
```
======================================================================
📋 数据质量检测报告
======================================================================

【本店】
   总商品数: 150
   ✅ 数据质量良好

【竞对】
   总商品数: 200
   ✅ 数据质量良好

======================================================================
✅ 数据质量优秀，可以开始比价
```

**结果**：自动继续运行，无需任何操作

---

### 场景2：仅有警告（自动通过）

**输出示例**：
```
======================================================================
📋 数据质量检测报告
======================================================================

【本店】
   总商品数: 120
   
   ⚠️  警告信息:
      ⚠️ 商品名称空值率 12.0% (14个)，建议<10%
      ⚠️ 商品数量较少（120个），匹配结果可能不理想（建议≥100个）

【竞对】
   总商品数: 150
   
   ⚠️  警告信息:
      ⚠️ 发现 5 个高价商品（>¥10000，最高¥15000.00），请确认是否正确

======================================================================
💡 数据质量总体良好，警告信息已记录，可以继续运行
```

**结果**：
- ✅ 自动继续运行
- 📝 警告信息记录到日志
- 💡 建议后续优化数据质量

**后续建议**：
- 补充本店的商品名称（空值行）
- 确认竞对的高价商品是否正确

---

### 场景3：严重问题（需确认）

**输出示例**：
```
======================================================================
📋 数据质量检测报告
======================================================================

【本店】
   总商品数: 100
   
   🚨 严重问题（建议修复后运行）:
      ❌ 发现 5 个负价格，数据异常
      ❌ 发现 10 个乱码商品名（文件编码错误），建议用UTF-8重新保存Excel
   
   ⚠️  警告信息:
      ⚠️ 商品名称空值率 15.0% (15个)，建议<10%

【竞对】
   总商品数: 150
   ✅ 数据质量良好

======================================================================

💡 建议:
   1. 修复上述严重问题后重新运行
   2. 如果确认数据无误，可以选择继续运行
======================================================================
检测到严重问题，是否继续运行? (y/n，默认n): _
```

**用户操作**：

**选项1：中止运行（推荐）**
```
检测到严重问题，是否继续运行? (y/n，默认n): n  # 或直接回车
❌ 已中止运行。请修复数据后重试。
```

**操作步骤**：
1. 打开Excel文件
2. 修复负价格（筛选价格<0的行）
3. 修复乱码（用UTF-8重新保存）
4. 补充空值商品名
5. 重新运行程序

---

**选项2：强制继续（不推荐）**
```
检测到严重问题，是否继续运行? (y/n，默认n): y
⚠️ 用户选择继续运行（忽略严重问题）

🎯 [步骤 4.5/7] 数据特征分析与参数推荐...
...继续后续流程
```

**警告**：
- ⚠️ 脏数据会导致匹配准确率下降
- ⚠️ 乱码可能导致程序崩溃
- ⚠️ 结果可能不可靠

**适用场景**：
- 您已确认数据无误（如负价格是特殊促销）
- 您想先查看匹配效果再决定是否修复
- 您接受较低的匹配准确率

---

## 📚 常见问题（FAQ）

### Q1: 为什么商品名重复率很高，但没有阻断运行？

**A**: 商品名重复在很多场景下是正常的：
- 多规格商品（如"可口可乐 330ml"和"可口可乐 500ml"商品名相同）
- 捆绑销售商品（如"零食大礼包"有多个SKU）

程序已内置多规格识别逻辑，能够正确处理这种情况。如果重复率>30%，仅会给出警告提示，不会阻断运行。

**何时需要关注**：
- 如果您的商品应该是唯一的（不同SKU应有不同商品名）
- 如果重复率异常高（>50%）且不是多规格商品

---

### Q2: 价格离群值警告是否一定要修复？

**A**: **不一定**。价格离群值警告仅提醒您确认数据是否正确，并不意味着一定有问题。

**正常情况**：
- 您销售高价商品（如家电：¥15000的冰箱）
- 您有少量高价商品（如¥12000的礼盒）

**异常情况**：
- 您通常销售低价商品（如零食），突然出现¥25000的商品 → 可能是录入错误
- 价格明显不合理（如¥250000可能是多输了两个0）

**建议**：检查一下报告中显示的"最高价格"，确认是否合理即可。

---

### Q3: 如何修复编码问题（乱码）？

**A**: 编码问题通常是Excel保存时使用了错误的编码格式。推荐以下两种方法：

**方法1：Excel另存为（推荐）**
```
1. 打开原始Excel文件
2. 点击"文件" → "另存为"
3. 选择"CSV UTF-8 (逗号分隔)(*.csv)"
4. 保存后，重新打开CSV
5. 另存为Excel格式(.xlsx)
6. 重新运行程序
```

**方法2：使用VS Code或记事本++**
```
1. 将Excel导出为CSV
2. 用VS Code或记事本++打开
3. 检查右下角编码格式
4. 转换为UTF-8编码
5. 保存后重新导入Excel
```

---

### Q4: 数据质量检测失败会影响程序运行吗？

**A**: **不会**。数据质量检测功能已内置异常处理：

```python
try:
    # 执行质量检测
    report_a = validate_input_data(df_all_a_temp, cfg.STORE_A_NAME)
    report_b = validate_input_data(df_all_b_temp, cfg.STORE_B_NAME)
    should_continue = print_data_quality_report(report_a, report_b)
except Exception as e:
    logging.warning(f"数据质量检测失败（已忽略）: {e}")
    print(f"⚠️ 数据质量检测执行失败（已忽略）: {e}")
    # 异常不影响主流程，继续运行
```

如果检测功能本身出错（极少发生），程序会：
- ⚠️ 显示警告信息
- 📝 记录异常到日志
- ✅ **继续后续流程**（不阻断）

---

### Q5: 如何禁用数据质量检测？

**A**: 目前版本不支持禁用（这是核心保护功能）。但您可以：

**临时跳过严重问题阻断**：
```
检测到严重问题，是否继续运行? (y/n，默认n): y
```
输入`y`即可继续运行。

**如果您确实需要完全禁用**（不推荐）：
1. 打开`product_comparison_tool_local.py`
2. 找到Line 6926-6951（步骤4.2/7）
3. 注释掉整个`try-except`块
4. 保存并运行

**警告**：禁用后可能导致脏数据进入匹配流程，影响准确率。

---

### Q6: 检测报告会保存到文件吗？

**A**: 当前版本仅在控制台显示报告，不会自动保存文件。但您可以：

**查看日志记录**：
```
logs/main_YYYYMMDD_HHMMSS.log
```
日志中会记录质量检测结果和用户选择。

**后续优化计划**（阶段3）：
- 📄 导出质量报告到`reports/data_quality_*.txt`
- 📊 生成质量评分卡
- 📈 追踪历史趋势

---

## 💡 最佳实践

### 1. 数据准备清单（运行前）

在运行程序前，建议快速检查：
- ✅ 商品名称列完整（无大量空值）
- ✅ 价格列完整（无负数或异常值）
- ✅ 文件编码正确（UTF-8）
- ✅ 商品数量充足（建议≥100个）
- ✅ 条码格式规范（8-13位）

### 2. 质量问题优先级

遇到多个问题时，优先修复：
1. 🚨 **编码问题（乱码）** - 最高优先级（会导致崩溃）
2. 🚨 **负价格** - 高优先级（数据异常）
3. ⚠️ **商品名空值** - 中优先级（影响匹配准确率）
4. ⚠️ **价格异常** - 中优先级（影响价格对比）
5. ⚠️ **数据规模小** - 低优先级（补充更多商品）

### 3. 警告信息处理策略

**可忽略的警告**：
- 商品名重复率高（如果是多规格商品）
- 价格离群值（如果确认是高价商品）
- 数据规模小（如果您本来就商品不多）

**建议修复的警告**：
- 商品名空值率高（补充商品名）
- 无效价格（补充或修正价格）
- 条码格式异常（修正条码）

### 4. 定期质量维护

建议每次运行前：
1. 查看上次的质量报告（如有）
2. 修复已知问题
3. 补充新增商品数据
4. 更新价格信息
5. 重新运行程序

---

## 🔧 技术细节（高级用户）

### 检测函数位置
```python
# 文件: product_comparison_tool_local.py

# 数据质量检测函数
def validate_input_data(df: pd.DataFrame, store_name: str) -> dict:
    # Line 1521-1660
    ...

# 报告格式化输出函数
def print_data_quality_report(report_a: dict, report_b: dict = None) -> bool:
    # Line 1663-1717
    ...
```

### 集成到主流程
```python
# main函数中（Line 6926-6951）

# 步骤4.2/7: 数据质量检测
print("🔍 [步骤 4.2/7] 数据质量检测...")
try:
    # 合并数据
    df_all_a_temp = pd.concat([df_a_barcode, df_a_no_barcode], ignore_index=True)
    df_all_b_temp = pd.concat([df_b_barcode, df_b_no_barcode], ignore_index=True)
    
    # 执行检测
    report_a = validate_input_data(df_all_a_temp, cfg.STORE_A_NAME)
    report_b = validate_input_data(df_all_b_temp, cfg.STORE_B_NAME)
    
    # 显示报告
    should_continue = print_data_quality_report(report_a, report_b)
    
    if not should_continue:
        sys.exit(0)  # 用户选择中止
except Exception as e:
    logging.warning(f"数据质量检测失败（已忽略）: {e}")
    # 异常不影响主流程
```

### 返回值格式
```python
{
    'store_name': str,       # 店铺名称
    'total_items': int,      # 商品总数
    'issues': list,          # 严重问题列表（阻断运行）
    'warnings': list,        # 警告列表（不阻断）
    'is_valid': bool         # 是否有效（无严重问题）
}
```

---

## 📖 相关文档

- **验收文档**: `优化项2.2_数据质量检测_验收文档.md`
- **开发计划**: `性能优化开发计划.md` - Line 480-600
- **主程序源码**: `product_comparison_tool_local.py`
- **智能参数推荐**: `智能参数推荐使用指南.md`

---

## 🆘 获取帮助

如果遇到问题：
1. 📋 查看控制台输出的详细报告
2. 📝 检查日志文件 `logs/main_*.log`
3. 📖 参考本使用指南的FAQ部分
4. 🔧 联系开发团队获取技术支持

---

**版本**: v1.0.0  
**更新时间**: 2025年1月  
**适用版本**: 阶段2优化版本及以后
