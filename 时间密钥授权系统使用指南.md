# 时间密钥授权系统 - 使用指南

## 🎯 新方案特点

### ✅ 管理员端（你）
- **工具**：只需要 `generate_license_key.py`（密钥生成器）
- **操作**：运行生成器 → 输入用户指纹 + 有效期 → 发送12位密钥给用户
- **无需**：
  - ❌ 不用维护 `authorized_keys.json`
  - ❌ 不用修改源代码
  - ❌ 不用重新打包程序

### ✅ 用户端
- **操作**：启动程序 → 输入12位密钥 → 开始使用
- **特点**：
  - ✅ 密钥自动绑定硬件（防止分享）
  - ✅ 密钥自动过期（到期自动失效）
  - ✅ 密钥简短易输入（12位大写字母+数字）

---

## 📋 完整工作流程

### Step 1: 用户申请授权

**用户操作**：
```powershell
# 运行硬件指纹工具
.\硬件指纹工具\硬件指纹工具.exe

# 获得指纹（16位）
# 示例: 2f4f7f10c353a8b0
```

**用户发给你**：硬件指纹（16位字符串）

---

### Step 2: 你生成密钥

**运行生成器**：
```powershell
python generate_license_key.py
```

**交互式操作**：
```
步骤1: 输入用户的硬件指纹（16位）
       → 输入: 2f4f7f10c353a8b0

步骤2: 选择有效期
       1. 30天  - 试用期
       2. 90天  - 季度授权
       3. 365天 - 年度授权
       4. 自定义天数
       → 选择: 2（90天）

结果: 生成12位密钥
      密钥: 8E2694C5CA5E
      有效期至: 2025年12月03日
```

**自动保存**：`license_2f4f7f10_20251203.txt`（授权凭证）

---

### Step 3: 发送密钥给用户

**复制以下内容发送给用户**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  O2O比价工具 - 授权密钥
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

您的授权密钥：8E2694C5CA5E
有效期至：2025年12月03日

使用方法：
  1. 启动 O2O比价工具
  2. 在授权对话框输入密钥：8E2694C5CA5E
  3. 点击确定，开始使用

注意：
- 此密钥仅限您的电脑使用（已绑定硬件）
- 请妥善保管密钥，遗失需重新申请
- 密钥到期后可联系管理员续期

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Step 4: 用户使用

**用户操作**：
1. 双击 `O2O_Comparison_Tool_PyQt6.exe`
2. 弹出授权对话框
3. 输入密钥：`8E2694C5CA5E`
4. 点击"确定"
5. ✅ 授权成功，开始使用

**提示信息**：
```
✅ 密钥验证通过

硬件绑定: 已验证
有效期至: 2025年12月03日
剩余天数: 90 天
```

---

## 🔧 管理场景

### 场景1: 新用户申请授权

```powershell
# 运行生成器
python generate_license_key.py

# 输入指纹和天数
# 发送12位密钥给用户
# 完成！
```

### 场景2: 用户密钥到期续期

```powershell
# 运行生成器
python generate_license_key.py

# 输入相同的指纹（用户不变）
# 选择新的有效期（30/90/365天）
# 生成新密钥发送给用户

# 用户只需输入新密钥即可续期
# 无需重新安装程序
```

### 场景3: 批量授权多个用户

```powershell
# 运行生成器
python generate_license_key.py

# 依次输入每个用户的指纹
# 每次生成后选择"y"继续
# 所有密钥自动保存到 license_*.txt

# 批量发送给用户
```

### 场景4: 撤销授权

**无需操作！**  
- 密钥到期自动失效
- 不续期即撤销授权

---

## 🔐 安全机制

### 硬件绑定
```
密钥 = Hash(用户硬件指纹 + 到期日期 + 主密钥盐值)
```

- ✅ 每台电脑的密钥都不同
- ✅ 密钥无法在其他电脑使用
- ✅ 用户无法分享密钥给他人

### 自动过期
```
验证时检查：当前日期 ≤ 到期日期
```

- ✅ 到期自动失效，无需手动撤销
- ✅ 支持30天试用、90天季度、365天年度授权

### 主密钥盐值
```python
MASTER_SALT = "O2O_COMPARISON_TOOL_2025_SECRET_SALT_V1"
```

- ✅ 只有你知道，内置在程序中
- ✅ 用户无法破解密钥生成算法
- ✅ 即使知道指纹和日期，也无法伪造密钥

---

## 📊 与旧方案对比

| 特性 | 旧方案（JSON文件） | 新方案（时间密钥） |
|------|------------------|------------------|
| 添加新用户 | 修改JSON → 重新打包 → 发送程序 | 运行生成器 → 发送12位密钥 |
| 撤销授权 | 修改JSON → 重新打包 → 通知所有用户 | 等待密钥过期（自动失效） |
| 续期授权 | 修改JSON → 重新打包 → 发送程序 | 生成新密钥 → 发送密钥 |
| 管理复杂度 | 高（需维护JSON文件） | 低（只需运行生成器） |
| 打包频率 | 每次授权变更 | 从不（除非程序更新） |
| 用户体验 | 收到新程序包（11GB） | 收到12位密钥（几秒钟） |

---

## 💡 最佳实践

### 授权记录管理

建议维护一个Excel表格：

| 授权日期 | 用户姓名 | 硬件指纹 | 密钥 | 有效期 | 到期日期 | 状态 |
|---------|--------|---------|------|--------|---------|------|
| 2025-11-03 | 张三 | 2f4f7f10**** | 8E2694C5CA5E | 90天 | 2025-12-03 | 有效 |
| 2025-11-03 | 李四 | a1b2c3d4**** | 3F7A82B1D9E4 | 30天 | 2025-12-03 | 有效 |

**记录来源**：每次生成密钥后，自动保存的 `license_*.txt` 文件

### 授权文件存档

```
授权记录/
├── 2025年11月/
│   ├── license_2f4f7f10_20251203.txt  # 张三
│   ├── license_a1b2c3d4_20251203.txt  # 李四
│   └── ...
├── 2025年12月/
│   └── ...
└── 授权管理表.xlsx
```

### 定期清理

- 每月检查到期密钥
- 删除过期用户的授权文件
- 更新Excel表格状态为"已过期"

---

## ❓ 常见问题

### Q1: 用户换了电脑怎么办？
**A**: 新电脑有新的硬件指纹，需要重新申请授权。用户运行硬件指纹工具获取新指纹，你生成新密钥。

### Q2: 用户密钥忘了怎么办？
**A**: 查看你保存的 `license_*.txt` 文件，找到对应用户的密钥，重新发送给他。

### Q3: 密钥到期前如何续期？
**A**: 运行生成器，输入相同的硬件指纹，选择新的有效期（如365天），生成新密钥发送给用户。用户输入新密钥即可续期。

### Q4: 可以生成永久密钥吗？
**A**: 选择365天，到期前再续期即可。不建议真正的"永久"密钥（安全考虑）。

### Q5: 密钥生成器会泄露吗？
**A**: 
- 生成器需要配合主程序内置的 `MASTER_SALT` 才能生成有效密钥
- 即使泄露生成器，没有 `MASTER_SALT` 也无法伪造密钥
- 建议妥善保管 `generate_license_key.py`，不要分享给任何人

### Q6: 用户说密钥无效怎么办？
**检查清单**：
1. 确认用户输入的指纹是否正确（让用户重新运行指纹工具）
2. 确认密钥拼写无误（区分大小写，但程序会自动转大写）
3. 确认用户电脑时间正确（时间误差超过30天会失效）
4. 让用户清除指纹缓存：删除 `.fingerprint_cache` 文件

---

## 🚀 快速上手

**5分钟授权一个新用户**：

```powershell
# 1. 收到用户指纹（用户发给你）
#    例如: 2f4f7f10c353a8b0

# 2. 运行生成器
python generate_license_key.py

# 3. 输入指纹和天数
#    指纹: 2f4f7f10c353a8b0
#    选择: 2 (90天)

# 4. 复制生成的密钥
#    密钥: 8E2694C5CA5E

# 5. 发送给用户
#    "您的密钥: 8E2694C5CA5E，有效期90天"

# 完成！
```

---

## 📝 附录：密钥格式说明

### 密钥特征
- **长度**：固定12位
- **字符**：大写字母 + 数字（0-9, A-F）
- **示例**：`8E2694C5CA5E`、`3F7A82B1D9E4`

### 验证算法
```python
密钥 = SHA256(硬件指纹 + 到期日期 + 主密钥盐值)[:12].upper()
```

**安全性**：
- SHA256 哈希算法（不可逆）
- 主密钥盐值加密（防止破解）
- 硬件绑定（防止分享）
- 时间限制（自动过期）

---

**需要帮助？** 联系系统管理员
