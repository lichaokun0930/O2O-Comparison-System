# O2O 比价工具 - 阿里云快速部署指南

## 🎯 您的优势
- ✅ 已有阿里云服务器
- ✅ 已有 VS Code Remote SSH（远程资源管理器）
- ✅ 部署时间：**10-15 分钟**

---

## 📋 部署步骤总览

```
本地电脑 → 上传代码 → 安装依赖 → 启动服务 → 配置防火墙 → 完成！
```

---

## 🚀 详细步骤

### 第1步：连接到阿里云服务器

#### 方式1：VS Code Remote SSH（推荐）
1. 打开 VS Code
2. 按 `F1`，输入 `Remote-SSH: Connect to Host`
3. 选择您的阿里云服务器
4. 连接成功后，打开终端（Ctrl + `）

#### 方式2：使用 PowerShell
```powershell
ssh root@您的阿里云IP
# 输入密码登录
```

---

### 第2步：上传项目代码

#### 方式1：使用 VS Code（最简单）
1. 在 VS Code 远程连接状态下
2. 点击 `文件` → `打开文件夹`
3. 创建目录：`/root/o2o_tool`
4. 直接从本地拖拽以下文件到远程目录：

**必需文件清单**：
```
o2o_tool/
├── comparison_app.py              # Streamlit 主程序
├── product_comparison_tool_local.py  # 比价引擎
├── requirements.txt               # 依赖列表
├── .streamlit/
│   └── config.toml               # 服务器配置
└── upload/                        # 上传目录（可选，自动创建）
    ├── 本店/
    └── 竞对/
```

#### 方式2：使用 SCP 命令（PowerShell）
```powershell
# 在本地项目目录下执行
cd "d:\Python1\O2O_Analysis\O2O数据分析\比价数据"

# 打包必需文件
$files = @(
    "comparison_app.py",
    "product_comparison_tool_local.py",
    "requirements.txt"
)

# 创建临时打包目录
New-Item -ItemType Directory -Force -Path "deploy_package"
foreach ($file in $files) {
    Copy-Item $file "deploy_package\"
}
Copy-Item -Recurse ".streamlit" "deploy_package\"

# 压缩
Compress-Archive -Path "deploy_package\*" -DestinationPath "o2o_tool.zip" -Force

# 上传到服务器
scp o2o_tool.zip root@您的阿里云IP:/root/

# 清理临时文件
Remove-Item -Recurse "deploy_package"
```

#### 方式3：使用 Git（最专业）
```bash
# 在服务器上执行
cd /root
git clone https://github.com/您的仓库/o2o_tool.git
# 或使用 Gitee 国内仓库
```

---

### 第3步：服务器环境配置

#### 在服务器终端执行：

```bash
# 进入项目目录
cd /root/o2o_tool

# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装 Python 3.11+（如果没有）
sudo apt install python3.11 python3-pip -y

# 3. 安装依赖（CPU 版本 PyTorch）
pip3 install streamlit pandas numpy openpyxl jieba tqdm -i https://pypi.tuna.tsinghua.edu.cn/simple

# 4. 安装 PyTorch CPU 版本
pip3 install torch --index-url https://download.pytorch.org/whl/cpu

# 5. 安装 sentence-transformers
pip3 install sentence-transformers -i https://pypi.tuna.tsinghua.edu.cn/simple

# 6. 验证安装
python3 -c "import streamlit, torch, sentence_transformers; print('✅ 所有依赖安装成功！')"
```

**如果已有 requirements.txt**：
```bash
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

### 第4步：配置 Streamlit

检查 `.streamlit/config.toml` 文件内容：

```toml
[server]
address = "0.0.0.0"
port = 8555
headless = true
enableCORS = false
enableXsrfProtection = false

[browser]
gatherUsageStats = false
```

**如果文件不存在，创建它**：
```bash
mkdir -p .streamlit
cat > .streamlit/config.toml << 'EOF'
[server]
address = "0.0.0.0"
port = 8555
headless = true
enableCORS = false
enableXsrfProtection = false

[browser]
gatherUsageStats = false
EOF
```

---

### 第5步：配置阿里云安全组

#### 在阿里云控制台操作：
1. 登录阿里云控制台
2. 进入 **ECS 实例** → 选择您的服务器
3. 点击 **安全组** → **配置规则**
4. 添加入方向规则：
   - **协议类型**：自定义 TCP
   - **端口范围**：8555/8555
   - **授权对象**：
     - 公司内网：填写您的公司公网 IP（更安全）
     - 所有人访问：`0.0.0.0/0`（不推荐）
   - **描述**：O2O 比价工具
5. 点击 **保存**

#### 或使用命令行（服务器内防火墙）：
```bash
# 如果使用 UFW
sudo ufw allow 8555/tcp
sudo ufw reload

# 如果使用 firewalld
sudo firewall-cmd --permanent --add-port=8555/tcp
sudo firewall-cmd --reload
```

---

### 第6步：启动应用

#### 方式1：前台运行（测试用）
```bash
cd /root/o2o_tool

# 设置环境变量（CPU 模式）
export CUDA_VISIBLE_DEVICES=""
export USE_TORCH_SIM="0"

# 启动应用
python3 -m streamlit run comparison_app.py
```

**访问地址**：`http://您的阿里云IP:8555`

#### 方式2：后台运行（推荐）
```bash
# 使用 nohup 后台运行
nohup python3 -m streamlit run comparison_app.py \
  --server.port 8555 \
  --server.address 0.0.0.0 \
  > streamlit.log 2>&1 &

# 查看日志
tail -f streamlit.log

# 查看进程
ps aux | grep streamlit

# 停止服务
pkill -f streamlit
```

#### 方式3：使用 systemd 服务（最稳定）
创建服务文件：
```bash
sudo nano /etc/systemd/system/o2o-tool.service
```

粘贴以下内容：
```ini
[Unit]
Description=O2O Comparison Tool - Streamlit
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/o2o_tool
Environment="CUDA_VISIBLE_DEVICES="
Environment="USE_TORCH_SIM=0"
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
ExecStart=/usr/bin/python3 -m streamlit run comparison_app.py --server.port 8555 --server.address 0.0.0.0
Restart=always
RestartSec=10
StandardOutput=append:/root/o2o_tool/streamlit.log
StandardError=append:/root/o2o_tool/streamlit_error.log

[Install]
WantedBy=multi-user.target
```

**启动服务**：
```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start o2o-tool

# 设置开机自启
sudo systemctl enable o2o-tool

# 查看状态
sudo systemctl status o2o-tool

# 查看日志
journalctl -u o2o-tool -f

# 重启服务
sudo systemctl restart o2o-tool

# 停止服务
sudo systemctl stop o2o-tool
```

---

### 第7步：验证部署

#### 1. 检查服务状态
```bash
# 检查端口监听
netstat -tlnp | grep 8555
# 或
ss -tlnp | grep 8555

# 应该看到类似输出：
# tcp   0   0.0.0.0:8555   0.0.0.0:*   LISTEN   12345/python3
```

#### 2. 本地测试
```bash
# 在服务器上测试
curl http://localhost:8555
# 应该返回 HTML 内容
```

#### 3. 浏览器测试
打开浏览器，访问：
```
http://您的阿里云IP:8555
```

应该看到 Streamlit 界面！

---

## 🎨 可选优化

### 1. 绑定域名（更专业）

#### 购买域名并解析：
1. 在阿里云购买域名（如 `o2o.yourdomain.com`）
2. 添加 A 记录：
   - **主机记录**：o2o
   - **记录类型**：A
   - **记录值**：您的阿里云 IP
   - **TTL**：10 分钟

#### 使用 Nginx 反向代理：
```bash
# 安装 Nginx
sudo apt install nginx -y

# 创建配置文件
sudo nano /etc/nginx/sites-available/o2o-tool
```

配置内容：
```nginx
server {
    listen 80;
    server_name o2o.yourdomain.com;

    location / {
        proxy_pass http://localhost:8555;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

启用配置：
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/o2o-tool /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

现在可以通过 `http://o2o.yourdomain.com` 访问！

### 2. 配置 HTTPS（更安全）

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 自动配置 SSL
sudo certbot --nginx -d o2o.yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

现在可以通过 `https://o2o.yourdomain.com` 访问！

### 3. 设置访问密码（可选）

编辑 `comparison_app.py`，在开头添加：
```python
import streamlit as st

# 简单密码验证
def check_password():
    def password_entered():
        if st.session_state["password"] == "您的密码":
            st.session_state["password_correct"] = True
            del st.session_state["password"]
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.text_input("请输入访问密码", type="password", 
                     on_change=password_entered, key="password")
        return False
    elif not st.session_state["password_correct"]:
        st.text_input("请输入访问密码", type="password", 
                     on_change=password_entered, key="password")
        st.error("密码错误")
        return False
    else:
        return True

if not check_password():
    st.stop()

# 原有代码继续...
```

---

## 📊 监控与维护

### 查看实时日志
```bash
# systemd 服务日志
journalctl -u o2o-tool -f

# 或查看文件日志
tail -f /root/o2o_tool/streamlit.log
```

### 查看资源占用
```bash
# CPU 和内存
top

# 磁盘空间
df -h

# 清理临时文件
cd /root/o2o_tool
rm -rf reports/*.xlsx
rm -f embedding_cache.joblib
```

### 更新代码
```bash
# 停止服务
sudo systemctl stop o2o-tool

# 备份旧版本
cp comparison_app.py comparison_app.py.bak

# 上传新文件（使用 VS Code Remote 或 SCP）

# 重启服务
sudo systemctl start o2o-tool
```

---

## ❓ 常见问题

### Q1: 无法访问 http://IP:8555？
**检查清单**：
1. ✅ 服务是否运行？`systemctl status o2o-tool`
2. ✅ 端口是否监听？`netstat -tlnp | grep 8555`
3. ✅ 阿里云安全组是否开放 8555 端口？
4. ✅ 服务器防火墙是否允许？`sudo ufw status`

### Q2: 启动失败，报 ModuleNotFoundError？
```bash
# 重新安装依赖
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q3: 上传文件后分析失败？
```bash
# 查看错误日志
journalctl -u o2o-tool -n 50

# 检查磁盘空间
df -h

# 检查 Python 环境
python3 -c "import torch; print(torch.__version__)"
```

### Q4: 如何限制只有公司 IP 访问？
**方法1：阿里云安全组**
- 授权对象改为公司公网 IP，如：`1.2.3.4/32`

**方法2：Nginx IP 白名单**
```nginx
location / {
    allow 1.2.3.4;  # 公司 IP
    deny all;
    proxy_pass http://localhost:8555;
}
```

### Q5: 内存不足怎么办？
```bash
# 添加 Swap 交换空间
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 调小批大小（修改 config 或环境变量）
export ENCODE_BATCH_SIZE=16
```

---

## 🎯 完整命令速查表

```bash
# ===== 服务管理 =====
sudo systemctl start o2o-tool      # 启动
sudo systemctl stop o2o-tool       # 停止
sudo systemctl restart o2o-tool    # 重启
sudo systemctl status o2o-tool     # 查看状态
sudo systemctl enable o2o-tool     # 开机自启

# ===== 日志查看 =====
journalctl -u o2o-tool -f          # 实时日志
journalctl -u o2o-tool -n 100      # 最近 100 行
tail -f /root/o2o_tool/streamlit.log

# ===== 端口检查 =====
netstat -tlnp | grep 8555
ss -tlnp | grep 8555
lsof -i :8555

# ===== 防火墙 =====
sudo ufw allow 8555/tcp
sudo ufw status

# ===== 进程管理 =====
ps aux | grep streamlit
pkill -f streamlit

# ===== 资源监控 =====
htop                               # 交互式监控
free -h                            # 内存使用
df -h                              # 磁盘空间
```

---

## 📞 获取帮助

### 访问地址
- **局域网**：`http://您的阿里云内网IP:8555`
- **公网**：`http://您的阿里云公网IP:8555`
- **域名**：`http://o2o.yourdomain.com`（配置后）

### 分享给用户
告诉他们：
> "打开浏览器，访问 `http://您的阿里云IP:8555`，上传文件即可分析，无需安装任何软件！"

### 技术支持
- Streamlit 文档：https://docs.streamlit.io/
- 阿里云帮助：https://help.aliyun.com/
- PyTorch 文档：https://pytorch.org/docs/

---

## ✅ 部署检查清单

- [ ] 代码已上传到服务器 `/root/o2o_tool/`
- [ ] Python 3.11+ 已安装
- [ ] 所有依赖已安装（torch, streamlit, sentence-transformers 等）
- [ ] `.streamlit/config.toml` 配置正确
- [ ] 阿里云安全组已开放 8555 端口
- [ ] systemd 服务已创建并启用
- [ ] 服务运行正常（`systemctl status o2o-tool`）
- [ ] 浏览器可访问 `http://IP:8555`
- [ ] 文件上传功能正常
- [ ] 比价分析功能正常
- [ ] 报告下载功能正常

**全部完成后，您的工具就可以 7x24 小时稳定运行了！** 🎉
