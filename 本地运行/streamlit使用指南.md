# 📖 Streamlit Web 版使用指南

## 🚀 快速开始

### 方法 1: 使用启动脚本（推荐）
```powershell
.\start_streamlit.ps1
```

### 方法 2: 使用安全启动器
```powershell
python run_streamlit_safe.py
```

### 方法 3: 手动启动（不推荐）
```powershell
# 1. 激活虚拟环境
.\.venv\Scripts\Activate.ps1

# 2. 设置环境变量
$env:CUDA_VISIBLE_DEVICES = ''
$env:USE_TORCH_SIM = '0'

# 3. 启动应用
streamlit run comparison_app.py
```

### 首次使用
1. 运行启动脚本后，浏览器会自动打开 `http://localhost:8501`
2. 如果浏览器未自动打开，手动访问该地址

## 🔧 技术架构

### 核心改进：子进程隔离

为了彻底解决 CUDA 库加载错误，Streamlit 版本采用**子进程隔离**架构：

```
Streamlit 主进程 (Web UI)
    ↓ 通过 subprocess 启动
比价分析子进程 (独立 Python 进程)
    ↓ 加载 PyTorch (CPU 模式)
生成分析报告
```

**优势**：
- ✅ 主进程不加载 PyTorch，避免 CUDA 错误
- ✅ 子进程崩溃不影响主进程
- ✅ 可以实时捕获分析进度
- ✅ 完全隔离，稳定可靠

## 📋 功能说明

### 主界面功能
- **文件上传**: 拖拽或点击上传本店和竞对的 Excel 数据
- **模型选择**: 6 种预训练模型可选，平衡速度和准确率
- **性能配置**: GPU 加速、批处理大小调整
- **实时日志**: 显示分析进度和详细日志
- **报告预览**: 在线预览分析结果的前 20 行数据
- **一键下载**: 下载完整的 Excel 分析报告

### 侧边栏配置

#### 模型选择
| 模型 | 速度 | 准确率 | 适用场景 |
|------|------|--------|---------|
| BGE-M3 多粒度模型 ⭐ | 较慢 | 顶级 | 推荐默认使用 |
| M3E 电商场景模型 | 较快 | 优秀 | 大批量快速分析 |
| BGE-Large 旗舰模型 | 较慢 | 顶级 | 追求极致准确率 |
| BGE-Base 中文优化 | 正常 | 优秀 | 平衡选项 |
| BGE-Small 轻量模型 | 快速 | 良好 | 低配置电脑 |
| 标准多语言模型 | 正常 | 良好 | 多语言场景 |

#### Cross-Encoder 精排
- **启用**: 准确率提升 40%，但速度降低 2-3 倍
- **禁用**: 速度快，适合日常快速分析
- **推荐**: 初次分析启用，后续微调可禁用

#### 性能配置
```
GPU 加速:
  ✅ 启用: 需要 NVIDIA GPU + CUDA
  ❌ 禁用: 使用 CPU 模式（兼容性好）

批处理大小:
  256: 显存 ≥8GB
  128: 显存 4-8GB (默认)
  64:  显存 <4GB
  32:  CPU 模式
```

## 🎯 使用流程

### 标准流程
```
1. 上传数据
   ├─ 本店数据: 点击 "选择本店商品数据 Excel 文件"
   └─ 竞对数据: 点击 "选择竞争对手商品数据 Excel 文件"

2. 配置参数（可选）
   ├─ 模型选择: 默认 BGE-M3 即可
   ├─ GPU 加速: 有 GPU 建议开启
   └─ 批处理大小: 根据显存调整

3. 开始分析
   └─ 点击 "🚀 开始比价分析"

4. 等待完成
   ├─ 查看实时日志了解进度
   └─ 大约需要 2-5 分钟

5. 查看结果
   ├─ 在线预览报告数据
   └─ 下载完整 Excel 报告
```

### 快速分析流程（无配置）
```
上传两个文件 → 点击"开始分析" → 下载报告
```

## 📊 报告说明

生成的 Excel 报告包含 9 个工作表：

| Sheet 编号 | 名称 | 说明 |
|-----------|------|------|
| 1 | 条码精确匹配 | 两店条码完全一致的商品 |
| 2 | 名称模糊匹配 | AI 语义匹配的相似商品 |
| 3 | 差异品对比 | 同类别但有差异的商品 |
| 4 | A店独有(全部) | 本店有但竞对无的所有 SKU |
| 5 | B店独有(全部) | 竞对有但本店无的所有 SKU |
| 6 | A店独有(去重) | 按商品名去重后的种类 |
| 7 | B店独有(去重) | 按商品名去重后的种类 |
| 8 | 品类缺口分析 | 本店缺失的品类组合 |
| 9 | 库存>0&折扣优势 | 双方有货且本店折扣更优 |

## 💡 使用技巧

### 提升速度
1. **使用 GPU 加速**: 速度提升 3-5 倍
2. **选择轻量模型**: M3E 或 BGE-Small
3. **禁用 Cross-Encoder**: 首次分析后可关闭
4. **增大批处理大小**: 有足够显存时设为 256

### 提升准确率
1. **使用旗舰模型**: BGE-Large 或 BGE-M3
2. **启用 Cross-Encoder**: 二次精排
3. **数据质量**: 确保 Excel 数据完整、格式正确

### 节省内存
1. **关闭其他程序**: 释放内存
2. **减小批处理大小**: 设为 32 或 64
3. **使用轻量模型**: BGE-Small

## 🔧 故障排除

### 浏览器未自动打开
```powershell
# 手动访问
http://localhost:8501
```

### 端口被占用
```powershell
# 指定其他端口启动
streamlit run comparison_app.py --server.port 8502
```

### CUDA 错误
```
解决方案:
1. 侧边栏关闭 "启用 GPU 加速"
2. 或者运行 .\diagnose_gpu.ps1 诊断
```

### 模型下载失败
```
原因: 网络问题或 Hugging Face 连接不稳定
解决:
1. 检查网络连接
2. 使用代理或 VPN
3. 或者配置本地模型路径（见 Config 类）
```

### 内存不足
```
症状: 程序崩溃或卡死
解决:
1. 减小批处理大小到 32
2. 关闭其他程序
3. 使用 BGE-Small 轻量模型
```

### 上传文件过大
```
Streamlit 默认限制 200MB
解决方案:
1. 创建 .streamlit/config.toml 文件
2. 添加配置:
   [server]
   maxUploadSize = 500
```

## 🆚 与命令行版本对比

| 特性 | Streamlit Web 版 | 命令行版 |
|------|-----------------|---------|
| 易用性 | ⭐⭐⭐⭐⭐ 图形界面 | ⭐⭐⭐ 需要命令行 |
| 文件上传 | 拖拽上传 | 手动放入目录 |
| 配置方式 | 可视化选择 | 编辑代码或环境变量 |
| 日志查看 | 实时显示 | 命令行输出 |
| 报告预览 | 在线预览 | 需打开 Excel |
| 跨平台 | ✅ 支持 | ✅ 支持 |
| 性能 | 相同 | 相同 |

## 🌐 部署到云端（可选）

### Streamlit Cloud（免费）
```
1. 注册 Streamlit Cloud 账号
2. 连接 GitHub 仓库
3. 部署应用
4. 获得公网访问链接
```

### 本地网络共享
```powershell
# 允许局域网访问
streamlit run comparison_app.py --server.address 0.0.0.0

# 其他设备访问
http://你的电脑IP:8501
```

## 📞 技术支持

### 常见问题
查看 `快速开始指南.md` 和 `CHANGELOG.md`

### 功能建议
欢迎提交功能需求和改进建议

### 版本信息
- Streamlit 版本: v2.0
- 基于: product_comparison_tool_local.py v8.5
- 更新日期: 2025年10月28日

---

**享受更便捷的比价分析体验！** 🎉
